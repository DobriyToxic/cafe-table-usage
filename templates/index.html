<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализ использования столов в кафе</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1"> Анализ использования столов в кафе</span>
        </div>
    </nav>

    <div class="container">
        <!-- Загрузка изображения -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"> Загрузите изображение кафе</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <input type="file" id="imageInput" accept="image/*" class="form-control">
                    <div class="form-text">Поддерживаются форматы: JPG, PNG, JPEG</div>
                </div>
                <button id="processBtn" class="btn btn-success w-100 btn-lg">
                    <i class="bi bi-search"></i> Анализировать изображение
                </button>
                <div id="loading" class="text-center mt-3" style="display:none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2">Обработка изображения... Пожалуйста, подождите</p>
                </div>
            </div>
        </div>

        <!-- Результаты анализа -->
        <div id="resultSection" class="card mb-4" style="display:none;">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"> Результаты анализа</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6>Оригинальное изображение:</h6>
                        <img id="originalImage" class="img-fluid rounded shadow" src="" alt="Оригинал">
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6>Изображение с детекцией:</h6>
                        <img id="annotatedImage" class="img-fluid rounded shadow" src="" alt="Результат">
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-4 mb-3">
                        <div class="card text-white bg-primary h-100">
                            <div class="card-body text-center">
                                <h2 id="totalTables" class="display-4 fw-bold">0</h2>
                                <p class="card-text mb-0">Всего столов</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card text-white bg-danger h-100">
                            <div class="card-body text-center">
                                <h2 id="occupiedCount" class="display-4 fw-bold">0</h2>
                                <p class="card-text mb-0">Занято</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card text-white bg-success h-100">
                            <div class="card-body text-center">
                                <h2 id="freeCount" class="display-4 fw-bold">0</h2>
                                <p class="card-text mb-0">Свободно</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="fw-bold">Загруженность:</span>
                        <span id="occupancyRate" class="fw-bold">0%</span>
                    </div>
                    <div class="progress" style="height: 30px;">
                        <div id="occupancyBar" class="progress-bar bg-warning" 
                             role="progressbar" style="width: 0%">
                            0%
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <h6>Дополнительная информация:</h6>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Обнаружено людей:</span>
                            <span id="peopleCount" class="badge bg-secondary">0</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between">
                            <span>Время анализа:</span>
                            <span id="analysisTime" class="badge bg-info">-</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- История анализов -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"> История анализов</h5>
            </div>
            <div class="card-body">
                <div id="historyContent" class="table-responsive">
                    <p class="text-muted">Здесь будет отображаться история ваших анализов</p>
                </div>
                <button id="loadHistoryBtn" class="btn btn-outline-info mt-2">
                    <i class="bi bi-arrow-clockwise"></i> Обновить историю
                </button>
                <button id="reportBtn" class="btn btn-warning mt-2 ms-2">
                    <i class="bi bi-file-earmark-pdf"></i> Сгенерировать отчёт (PDF)
                </button>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white text-center py-3 mt-4">
        <div class="container">
            <p class="mb-0">Практика МТУСИ | Вариант 25: Анализ использования столов в кафе</p>
            <p class="mb-0 small">Разработано с использованием YOLOv8 и Flask</p>
        </div>
    </footer>

    <script>
        const processBtn = document.getElementById('processBtn');
        const imageInput = document.getElementById('imageInput');
        const loading = document.getElementById('loading');
        const resultSection = document.getElementById('resultSection');

        processBtn.addEventListener('click', async () => {
            const file = imageInput.files[0];
            if (!file) {
                alert(' Пожалуйста, выберите изображение!');
                return;
            }

            // Показать индикатор загрузки
            loading.style.display = 'block';
            resultSection.style.display = 'none';
            processBtn.disabled = true;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const startTime = Date.now();
                const response = await fetch('/process', {
                    method: 'POST',
                    body: formData
                });

                const endTime = Date.now();
                const duration = ((endTime - startTime) / 1000).toFixed(1);

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Ошибка сервера');
                }

                const data = await response.json();

                // Обновить результаты
                document.getElementById('totalTables').textContent = data.stats.total_tables;
                document.getElementById('occupiedCount').textContent = data.stats.occupied;
                document.getElementById('freeCount').textContent = data.stats.free;
                document.getElementById('occupancyRate').textContent = `${data.stats.occupancy_rate}%`;
                document.getElementById('occupancyBar').style.width = `${data.stats.occupancy_rate}%`;
                document.getElementById('occupancyBar').textContent = `${data.stats.occupancy_rate}%`;
                // УБРАЛИ строку с chairsCount
                document.getElementById('peopleCount').textContent = data.detections.people_count;
                document.getElementById('analysisTime').textContent = `${duration} сек`;

                // Показать изображения
                document.getElementById('originalImage').src = data.original_image_url + '?t=' + Date.now();
                document.getElementById('annotatedImage').src = data.annotated_image_url + '?t=' + Date.now();

                // Пать секцию результатов
                resultSection.style.display = 'block';
                
                // Обновить историю
                loadHistory();

            } catch (error) {
                alert(` Ошибка: ${error.message}`);
                console.error(error);
            } finally {
                loading.style.display = 'none';
                processBtn.disabled = false;
            }
        });

        // Загрузка истории
        async function loadHistory() {
            try {
                const response = await fetch('/history');
                const data = await response.json();
                
                if (!data.success || !data.history || data.history.length === 0) {
                    document.getElementById('historyContent').innerHTML = 
                        '<p class="text-muted">История пуста</p>';
                    return;
                }

                let html = `
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Дата/Время</th>
                                <th>Столов</th>
                                <th>Занято</th>
                                <th>Свободно</th>
                                <th>Загруженность</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.history.slice().reverse().forEach(record => {
                    const time = new Date(record.timestamp).toLocaleString('ru-RU');
                    const s = record.stats;
                    html += `
                        <tr>
                            <td>${time}</td>
                            <td>${s.total_tables}</td>
                            <td>${s.occupied}</td>
                            <td>${s.free}</td>
                            <td>
                                <div class="progress" style="height:20px;">
                                    <div class="progress-bar ${s.occupancy_rate > 70 ? 'bg-danger' : s.occupancy_rate > 40 ? 'bg-warning' : 'bg-success'}" 
                                         role="progressbar" 
                                         style="width: ${s.occupancy_rate}%;">
                                        ${s.occupancy_rate}%
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += `</tbody></table>`;
                document.getElementById('historyContent').innerHTML = html;
            } catch (error) {
                console.error('Ошибка загрузки истории:', error);
                document.getElementById('historyContent').innerHTML = 
                    '<p class="text-danger">Ошибка загрузки истории</p>';
            }
        }

        document.getElementById('loadHistoryBtn').addEventListener('click', loadHistory);

        // Генерация отчёта
        document.getElementById('reportBtn').addEventListener('click', async () => {
            if (!confirm('Сгенерировать отчёт на основе последних 15 анализов?')) {
                return;
            }

            try {
                const response = await fetch('/report');
                const data = await response.json();

                if (data.success) {
                    alert(' Отчёт успешно сгенерирован! Скачивание начнётся автоматически.');
                    window.open(data.report_url, '_blank');
                } else {
                    alert(` Ошибка: ${data.error}`);
                }
            } catch (error) {
                alert(` Ошибка генерации отчёта: ${error.message}`);
            }
        });

        // Автоматическая загрузка истории при открытии страницы
        window.addEventListener('load', loadHistory);
    </script>
</body>
</html>